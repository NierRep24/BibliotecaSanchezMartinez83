@model IEnumerable<BibliotecaDanielSanchez83.Models.Domain.Libro>
@{
    Layout = "_LayoutDashboard";
}

<div class="flex flex-col flex-1 p-6">
    <h1 class="text-blue-900 text-xl font-bold">
        Dashboard
    </h1>

    <div class="mt-4">
        <a asp-action="Crear" asp-controller="Libros" class="bg-blue-900 text-white px-4 py-2 rounded hover:bg-blue-600">
            <i class=""></i> Nuevo Libro
        </a>
    </div>

    <div class="mt-6 bg-white shadow-md rounded-lg p-4">
        <h1 class="text-lg font-semibold mb-4">Lista de Libros</h1>

        @if (Model.Count() > 0)
        {
            <div class="overflow-x-auto">
                <table id="tblLibro" class="w-full border border-gray-200 text-left">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border">@Html.DisplayNameFor(x => x.Titulo)</th>
                            <th class="p-2 border">@Html.DisplayNameFor(x => x.Autor)</th>
                            <th class="p-2 border">Categorías</th> <!-- Nueva columna para las categorías -->
                            <th class="p-2 border">@Html.DisplayNameFor(x => x.FechaPublicacion)</th>
                            <th class="p-2 border">@Html.DisplayNameFor(x => x.Descripcion)</th>
                            <th class="p-2 border">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="border hover:bg-gray-50">
                                <td class="p-2 border">@Html.DisplayFor(x => item.Titulo)</td>
                                <td class="p-2 border">@Html.DisplayFor(x => item.Autor.Nombre)</td>
                                <td class="p-2 border">
                                    @if (item.LibroCategorias != null && item.LibroCategorias.Any())
                                    {
                                        @foreach (var categoria in item.LibroCategorias)
                                        {
                                            <span>@categoria.Categoria.Nombre </span>

                                            <br />
                                        }
                                    }
                                    else
                                    {
                                        <span>No tiene categorías</span>
                                    }
                                </td>


                                <td class="p-2 border">@Html.DisplayFor(x => item.FechaPublicacion)</td>
                                <td class="p-2 border">@Html.DisplayFor(x => item.Descripcion)</td>
                                <td class="p-4 border border-0 flex space-x-2">
                                    <a class="text-green-500 hover:bg-green-50 hover:text-green-500 p-2 rounded-lg" asp-action="Editar" asp-route-id="@item.PkLibro">Editar</a>
                                    <a class="text-red-500 hover:bg-red-50 hover:text-red-500 p-2 rounded-lg eliminar-libro" data-id="@item.PkLibro"><i class="da-solid fa-trash"></i>Eliminar</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-gray-500">No hay registros de libros</p>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Llamar a datatable
            $('#tblLibro').DataTable({
                language: {
                    "decimal": "",
                    "emptyTable": "No hay información",
                    "info": "Mostrando START a END de TOTAL Entradas",
                    "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
                    "infoFiltered": "(Filtrado de MAX total entradas)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Mostrar MENU Entradas",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscar:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                }
            });

            // Eliminar libro
            $('.eliminar-libro').on('click', function () {
                Swal.fire({
                    title: "¿Estás seguro de que deseas borrar este libro?",
                    text: "¡No podrás revertir esto!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, deseo borrar!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        var libroId = $(this).data('id');

                        $.ajax({
                            url: '/Libros/Eliminar/' + libroId,
                            type: 'DELETE',
                            success: function (data) {
                                if (data.succes == true) {
                                    location.reload(); // Recarga la página completa
                                }
                            }
                        });

                        Swal.fire({
                            title: "¡Eliminado!",
                            text: "El libro ha sido eliminado correctamente.",
                            icon: "success",
                            timer: 700
                        });
                    }
                });
            });
        });
    </script>
}
